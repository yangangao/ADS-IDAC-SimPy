# Maritime ADS-IDAC 系统开发方案及计划（第一阶段）
## 1.ADS-IDAC-SimPy
本项目的动态事件树部分基于开源python程序库SimPy开发。SimPy主要提供了本系统的时钟及事件分支的自动生成功能。
ADS-IDAC system development by using SimPy.
## 2.船舶避碰场景的ADS设置（2019-12-25）
本部分考虑采用第三人称视角全局展示船舶碰撞场景，船舶的避碰场景一般可以分成三类：对遇(head-on)，追越(over-taking)和交叉会遇(crossing)。其中又以交叉会遇场景最为普遍。在现阶段的开发中先考虑交叉会遇的情况。由交叉会遇的场景可以很容易的扩展到对遇和追越场景。

当前首先考虑船舶避碰场景的ADS-IDAC，因此，仿真截止到发生碰撞（暂时设为：Distance<10m）或成功避碰（暂时设为：DCPA>1海里）。
### 2.1 单船在碰撞事故中的一般逻辑
船舶避碰事故一般要经历如下的过程：

![避碰基本逻辑图](https://github.com/Eternal-Br/ADS-IDAC-SimPy/blob/master/%E5%BC%80%E5%8F%91%E6%96%87%E6%A1%A3/images/%E5%9F%BA%E6%9C%AC%E9%80%BB%E8%BE%91%E5%9B%BE.jpg)

上述过程依照逻辑顺序开展，因此顺序上不会发生颠倒,如作出决策一定在发现风险之后。

单船的避碰逻辑设计分为风险感知与确认，避碰决策与沟通，操纵三个部分。其中前两个部分较复杂。

#### 2.1.1 风险感知与确认
在发生风险即DCPA<n之后，前两个事件设备发出碰撞警报和人工确认风险的详细流程如下：

![PE1-PE2](https://github.com/Eternal-Br/ADS-IDAC-SimPy/blob/master/%E5%BC%80%E5%8F%91%E6%96%87%E6%A1%A3/images/PE1-PE2%202.jpg)

首先，关于DDET的注释：
* 除基本事件和结果之前的最后一个中间事件外，每一个中间事件会产生至少2个分支组成，含有2个分支的中间事件叫标准事件，大于2分支的中间事件是多分支事件。标准事件后的分支，直线向后的表示‘YES’事件，向下的折线连接下一个事件的表示‘NO’事件。所有中间事件的分支的概率和为1；
* DDET的节点生成有3种方式：物理环境事件，如DCPA<n、两船距离进入6nm的视距范围等；人因事件，如发现风险、作出决策等；机械事件，如发出警报、船舶操纵响应等；

关于风险感知与确认部分的DDET详细流程如下
1. 初始状态下，两船按照预设和水动力学模型前进。实时计算DCPA和距离Dis。**第一个物理环境触发事件**发生在DCPA<n时，触发***设备报警***。预警设备报警的可靠性是P_Al1,即只要DCPA<n每个时间段都会生成一个节点。节点的“YES”事件是成功发出警报并让人接收（人没有看到的也不算）；“NO”事件是没有发出警报或人没有接收到警报。这时事件发生在视距外，依靠机械报警和***人工收到报警后确认风险***。如果确认风险（“YES”）则进入***避碰决策***，如果认为无风险（“NO”）则返回等待下一个时刻***设备报警***。

2. 如果***设备报警***和***人工确认风险***一直不能确认，随着场景进展，两船距离越来越近，进入**第二个物理环境触发事件**：两船进入6海里（nm）的可视识别区。在实际的航行中一般以6nm为界，6nm之内人工发现风险级别高于机器报警，即同时发现风险时，按照人工发现风险算，这与事实也相吻合。这时风险确认相关的事件转变为3分支事件，即***视觉确认风险***、机器的***视距内报警***和***无报警***，三者的关系如下图。***视觉确认风险***后直接进入***避碰决策***；***视距内报警***后进入***人工确认风险***，如果***人工确认风险***为“YES”则进入***避碰决策***，为“NO”则再次进入***进入视距内***物理事件；***无报警***事件直接进入新的***进入视距内***物理事件。

![设备报警和人工确认风险的关系](https://github.com/Eternal-Br/ADS-IDAC-SimPy/blob/master/%E5%BC%80%E5%8F%91%E6%96%87%E6%A1%A3/images/%E8%AE%BE%E5%A4%87%E6%8A%A5%E8%AD%A6%E5%92%8C%E4%BA%BA%E5%B7%A5%E7%A1%AE%E8%AE%A4%E9%A3%8E%E9%99%A9%E7%9A%84%E5%85%B3%E7%B3%BB.jpg)

3. 至此，单船的风险感知与确认流程完成。如果所有的***设备报警***或***人工确认风险***事件都失效即全为“NO”，意味着本船始终没有作出任何决策，在物理模型中表现为保持航速航行前进。在两艘船的场景中，表现为两船都保持航速航向前进，直到***碰撞事故发生***。所以，全为“NO”的场景的结束事件是**第三个物理环境触发事件**：船舶碰撞。

#### 2.1.2 循环前进的避碰决策措施
***人工确认风险***之后进入***避碰决策***环节。本环节是以循环的方式迭代演进的。

![PE3-PE6详细](https://github.com/Eternal-Br/ADS-IDAC-SimPy/blob/master/%E5%BC%80%E5%8F%91%E6%96%87%E6%A1%A3/images/PE3-PE6%E8%AF%A6%E7%BB%86.svg)

1. 在***人工确认风险***后，首先尝试与目标船进行***避碰沟通***。沟通顺利（“YES”）则进入***有沟通的避碰决策***，此时按照商议的结果进行3分支的决策，此时以沟通内容为主，另外两个错误决策的概率依次减小；未成功沟通（“NO”）则进入***无沟通的避碰决策***，此时按照本船的理解进行3分支的决策，概率完全按照本船的理解决策内容进行决策；

2. 避碰决策分为有沟通和无沟通的情况，二者都是按照左转5˚、不转、右转5˚安排的。且每一次都是在上次的基础上，即若第一次左转5˚，第二次决策保持左转5˚的决策应该为不转，继续左转5˚的决策则实际表现为较最初左转了10˚。3分支事件***避碰决策***中每个分支的概率P_R5,P_M0,P_L5由沟通结果、决策者的IDAC模型和决策模型综合计算得到；

3. 避碰决策的后续事件***避碰操纵***表示操纵者对决策的接受程度和执行程度，“YES”表示正确的执行了决策，“NO”表示没有执行，即保持本次决策前的状态；

4. ***避碰操纵***的后续事件***机械响应***表示船舶的机械结构对操纵的响应程度，与机械的可靠性有关，“YES”表示正确的响应了操纵，“NO”表示没有响应，即保持本次决策前的状态；

5. ***机械响应***是本次决策循环的结束，不论事件是“YES”或“NO”响应结束之后的固定时间t_Dec，进行***避碰效果确认***。这里，在DDET上不论***机械响应***的结果是“YES”或“NO”，后续事件都是***避碰效果确认***，但是在物理引擎上的表现是完全不同的，因此算作一个独立事件；

6. 每个决策周期开始，都是***避碰效果确认***，“YES”表示经过确认，当前的避碰措施正确，且没有摆脱危险局面，因此继续上一个决策中的状态，直到当前的t_Dec结束，开始下一次***避碰效果确认***；“NO”表示经过确认，当前避碰措施不正确，重新开始***避碰沟通***及后续一整套流程；

7. 当前的场景结束有两种可能，***发生碰撞***和***避碰成功***，这两个结束状态均由物理引擎终止，不论处于哪一个事件环节，一旦物理引擎检测到两船脱离碰撞风险（由航向和距离确认，即DCPA即为当前距离，从此两船越来越远）或者距离过近碰撞发生，记录当前DDET路径和结果，计算最终结束事件的概率。

##### 2.1.2.1 避碰沟通
由上图可以看出，在上个阶段人工确认风险之后，首先尝试与目标船沟通，

##### 2.1.2.2 避碰决策


#### 2.1.2.3 避碰操纵


### 2.2 两艘船在船舶碰撞事故中的ADS模型




## 3.系统开发日志
1.完成系统基本框架设计（肖老师，李卓）；

2.完成动态事件树自动生成分支功能（李卓）；

3.完成船舶的水动力学模型（张老师）；

4.完成基于速度障碍法的动态障碍物风险区域计算和展示（张老师）；
